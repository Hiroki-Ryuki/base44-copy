'use client';

import React, { useState, useCallback } from 'react';
import { Button } from '@/components/ui/button';
import { Share2, Check } from 'lucide-react';
import { motion } from 'framer-motion';

/**
 * fortune 型の前提:
 * {
 *   name: string
 *   fortune_type: string
 *   result: string
 * }
 */

export default function ShareButton({ fortune }: { fortune: any }) {
  const [copied, setCopied] = useState(false);

  const handleCopy = useCallback(async (text: string) => {
    try {
      if (navigator?.clipboard?.writeText) {
        await navigator.clipboard.writeText(text);
      } else {
        // 古いブラウザ向けフォールバック
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        document.body.appendChild(textarea);
        textarea.focus();
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
      }

      setCopied(true);
      setTimeout(() => setCopied(false), 2000);
    } catch {
      // コピー失敗時は何もしない（UX優先）
    }
  }, []);

  const handleShare = useCallback(async () => {
    if (!fortune) return;

    const resultText =
      typeof fortune.result === 'string'
        ? fortune.result.slice(0, 100)
        : '';

    const shareText = `【100円占い】
${fortune.name}さんの運勢: ${fortune.fortune_type}

${resultText}${resultText.length === 100 ? '...' : ''}

#100円占い #占い #運勢`;

    // Web Share API（モバイル優先）
    if (typeof navigator !== 'undefined' && navigator.share) {
      try {
        await navigator.share({ text: shareText });
        return;
      } catch (err: any) {
        // ユーザーキャンセル以外はコピーへフォールバック
        if (err?.name === 'AbortError') return;
      }
    }

    // Clipboard API フォールバック
    await handleCopy(shareText);
  }, [fortune, handleCopy]);

  return (
    <motion.div
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
      transition={{ delay: 1 }}
    >
      <Button
        onClick={handleShare}
        type="button"
        className="w-full bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700 text-white font-medium py-6 text-lg shadow-lg hover:shadow-xl transition-all duration-300"
      >
        {copied ? (
          <span className="flex items-center justify-center gap-2">
            <Check className="w-5 h-5" />
            コピーしました！
          </span>
        ) : (
          <span className="flex items-center justify-center gap-2">
            <Share2 className="w-5 h-5" />
            結果をシェアする
          </span>
        )}
      </Button>

      <p className="text-center text-white/40 text-sm mt-3">
        スクショしてSNSでシェアしよう！
      </p>
    </motion.div>
  );
}
